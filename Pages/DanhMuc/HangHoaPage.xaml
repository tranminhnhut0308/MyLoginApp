<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MyLoginApp.ViewModels"
             xmlns:converters="clr-namespace:MyLoginApp.Converter"
             x:Class="MyLoginApp.Pages.HangHoaPage"
             BackgroundColor="#f5f5f5">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:DisplayPriceConverter x:Key="DisplayPriceConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Shell.TitleView>
        <Grid ColumnDefinitions="*,Auto">
            <Label Text="ðŸ“¦ HÃ ng HÃ³a"
                   TextColor="White"
                   FontSize="22"
                   FontAttributes="Bold"
                   VerticalTextAlignment="Center" />
            <Button Text="ðŸ”"
                    Grid.Column="1"
                    FontSize="22"
                    FontAttributes="Bold"
                    Clicked="OnTimKiemClicked"
                    BackgroundColor="Transparent"
                    BorderColor="Transparent"
                    TextColor="White"
                    VerticalOptions="Center"
                    Padding="0,0,10,0"/>
        </Grid>
    </Shell.TitleView>

    <ContentPage.BindingContext>
        <viewmodels:HangHoaViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*,Auto" Padding="10">
        <!-- KHU Vá»°C NÃšT ÄIá»€U KHIá»‚N -->
        <Grid Grid.Row="0" RowDefinitions="Auto,Auto,Auto" Margin="0,0,0,10">
            <!-- Khu vá»±c buttons Ä‘iá»u khiá»ƒn -->
            <HorizontalStackLayout Grid.Row="0" Spacing="15" HorizontalOptions="CenterAndExpand">
                <Button Text="âž• ThÃªm" Command="{Binding ShowAddFormCommand}"
                        BackgroundColor="#4CAF50" TextColor="Black" WidthRequest="110" HeightRequest="50" CornerRadius="20" />

                <Button Text="âœï¸ Sá»­a" Command="{Binding ShowEditFormCommand}"
                        IsEnabled="{Binding SelectedHangHoa, Converter={StaticResource NullToBooleanConverter}}"
                        BackgroundColor="#FFCF07" TextColor="Black" WidthRequest="110" HeightRequest="50" CornerRadius="20">
                    <Button.Triggers>
                        <Trigger TargetType="Button" Property="IsEnabled" Value="False">
                            <Setter Property="BackgroundColor" Value="#FFCF07" />
                            <Setter Property="Opacity" Value="0.7" />
                        </Trigger>
                    </Button.Triggers>
                </Button>

                <Button Text="ðŸ—‘ï¸ XÃ³a" Command="{Binding DeleteCommand}"
                        IsEnabled="{Binding SelectedHangHoa, Converter={StaticResource NullToBooleanConverter}}"
                        BackgroundColor="#F44336" TextColor="Black" WidthRequest="110" HeightRequest="50" CornerRadius="20">
                    <Button.Triggers>
                        <Trigger TargetType="Button" Property="IsEnabled" Value="False">
                            <Setter Property="BackgroundColor" Value="#F44336" />
                            <Setter Property="Opacity" Value="0.7" />
                        </Trigger>
                    </Button.Triggers>
                </Button>
            </HorizontalStackLayout>

            <!-- ThÃ´ng bÃ¡o má»¥c Ä‘Ã£ chá»n -->
            <Label Grid.Row="2" 
                   Text="{Binding SelectedHangHoa.TenHangHoa, StringFormat='âœ… ÄÃ£ chá»n: {0}'}" 
                   TextColor="#2E7D32" 
                   FontAttributes="Bold"
                   FontSize="16"
                   HorizontalOptions="Center"
                   IsVisible="False"
                   Margin="0,5,0,0"/>
        </Grid>

        <!-- FORM THÃŠM HÃ€NG HÃ“A -->
        <Grid Grid.Row="1" IsVisible="{Binding IsAdding}" BackgroundColor="#f9f9f9" Padding="20" RowDefinitions="Auto,*,Auto">
            <ScrollView Grid.Row="1" Margin="0,10">
                <VerticalStackLayout Spacing="15">
                    <Grid ColumnDefinitions="Auto,*"
                          ColumnSpacing="10"
                          RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                          RowSpacing="15">
                        <!-- TÃªn hÃ ng hÃ³a -->
                        <Label Grid.Row="0" Grid.Column="0" Text="TÃªn hÃ ng hÃ³a:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="0" Grid.Column="1" Text="{Binding FormHangHoa.TenHangHoa}" Placeholder="Nháº­p tÃªn hÃ ng hÃ³a" />
                        <!-- Loáº¡i vÃ ng -->
                        <Label Grid.Row="1" Grid.Column="0" Text="Loáº¡i vÃ ng:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Picker Grid.Row="1" Grid.Column="1"
                                ItemsSource="{Binding DanhSachLoaiVang}"
                                SelectedItem="{Binding FormHangHoa.LoaiVang, Mode=TwoWay}"
                                Title="Chá»n loáº¡i vÃ ng" />
                        <!-- NhÃ³m -->
                        <Label Grid.Row="2" Grid.Column="0" Text="NhÃ³m:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Picker Grid.Row="2" Grid.Column="1"
                                ItemsSource="{Binding DanhSachNhom}"
                                SelectedItem="{Binding FormHangHoa.Nhom, Mode=TwoWay}"
                                Title="Chá»n nhÃ³m" />
                        <!-- CÃ¢n tá»•ng -->
                        <Label Grid.Row="3" Grid.Column="0" Text="CÃ¢n tá»•ng:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="3" Grid.Column="1" Text="{Binding FormHangHoa.CanTong}" Keyboard="Numeric" />
                        <!-- TL há»™t -->
                        <Label Grid.Row="4" Grid.Column="0" Text="TL há»™t:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="4" Grid.Column="1" Text="{Binding FormHangHoa.TrongLuongHot}" Keyboard="Numeric" />
                        <!-- Trá»« há»™t (readonly, tá»± Ä‘á»™ng tÃ­nh) -->
                        <Label Grid.Row="5" Grid.Column="0" Text="Trá»« há»™t:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="5" Grid.Column="1"
                               Text="{Binding FormHangHoa.TruHot}"
                               IsReadOnly="True"
                               IsEnabled="False" />
                        <!-- CÃ´ng gá»‘c -->
                        <Label Grid.Row="6" Grid.Column="0" Text="CÃ´ng gá»‘c:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="6" Grid.Column="1"
                               Text="{Binding FormHangHoa.CongGoc, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Unfocused="CongGocEntry_Unfocused"/>
                        <!-- GiÃ¡ cÃ´ng -->
                        <Label Grid.Row="7" Grid.Column="0" Text="GiÃ¡ cÃ´ng:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="7" Grid.Column="1"
                               Text="{Binding FormHangHoa.GiaCong}"
                               Keyboard="Numeric"
                               Unfocused="GiaCongEntry_Unfocused"/>
                        <!-- ÄÆ¡n giÃ¡ gá»‘c -->
                        <Label Grid.Row="8" Grid.Column="0" Text="ÄÆ¡n giÃ¡ gá»‘c:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="8" Grid.Column="1"
                               Text="{Binding FormHangHoa.DonViGoc}"
                               Keyboard="Numeric"
                               Unfocused="DonViGocEntry_Unfocused"/>
                        <!-- Ghi chÃº -->
                        <Label Grid.Row="9" Grid.Column="0" Text="Ghi chÃº:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="9" Grid.Column="1" Text="{Binding FormHangHoa.GhiChu}" Placeholder="Nháº­p ghi chÃº" />
                    </Grid>
                </VerticalStackLayout>
            </ScrollView>
            <HorizontalStackLayout Grid.Row="2" HorizontalOptions="Center" Spacing="15">
                <Button Text="ðŸ’¾ LÆ°u" Command="{Binding SaveAddCommand}" BackgroundColor="#4CAF50" TextColor="White" WidthRequest="120" HeightRequest="45" CornerRadius="22" />
                <Button Text="âŒ Há»§y" Command="{Binding CancelFormCommand}" BackgroundColor="#9E9E9E" TextColor="White" WidthRequest="120" HeightRequest="45" CornerRadius="22" />
            </HorizontalStackLayout>
        </Grid>

        <!-- FORM Sá»¬A HÃ€NG HÃ“A -->
        <Grid Grid.Row="1" IsVisible="{Binding IsEditing}" BackgroundColor="#f9f9f9" Padding="20" RowDefinitions="Auto,*,Auto">
            <Label Text="âœï¸ Sá»¬A THÃ”NG TIN HÃ€NG HÃ“A" FontAttributes="Bold" FontSize="22" HorizontalOptions="Center" TextColor="#333" />

            <ScrollView Grid.Row="1" Margin="0,10">
                <VerticalStackLayout Spacing="15">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="15">
                        <!-- TÃªn hÃ ng -->
                        <Label Grid.Row="0" Grid.Column="0" Text="TÃªn hÃ ng:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="0" Grid.Column="1" Text="{Binding FormHangHoa.TenHangHoa}" Placeholder="Nháº­p tÃªn hÃ ng hÃ³a" />

                        <!-- NhÃ³m -->
                        <Label Grid.Row="1" Grid.Column="0" Text="Loáº¡i vÃ ng:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Picker Grid.Row="1" Grid.Column="1" ItemsSource="{Binding DanhSachNhom}" SelectedItem="{Binding FormHangHoa.Nhom}" />

                        <!-- Loáº¡i vÃ ng -->
                        <Label Grid.Row="2" Grid.Column="0" Text="NhÃ³m:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Picker Grid.Row="2" Grid.Column="1" ItemsSource="{Binding DanhSachLoaiVang}" SelectedItem="{Binding FormHangHoa.LoaiVang}" />

                        <!-- CÃ¢n tá»•ng -->
                        <Label Grid.Row="3" Grid.Column="0" Text="CÃ¢n tá»•ng:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="3" Grid.Column="1" Text="{Binding FormHangHoa.CanTong}" Keyboard="Numeric" />

                        <!-- Trá»ng lÆ°á»£ng há»™t -->
                        <Label Grid.Row="4" Grid.Column="0" Text="TL Há»™t:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="4" Grid.Column="1" Text="{Binding FormHangHoa.TrongLuongHot}" Keyboard="Numeric" />

                        <!-- CÃ´ng gá»‘c -->
                        <Label Grid.Row="5" Grid.Column="0" Text="CÃ´ng gá»‘c:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry
                            Text="{Binding FormHangHoa.CongGoc, Converter={StaticResource DisplayPriceConverter}, Mode=TwoWay}"
                            Keyboard="Numeric"
                            Placeholder="0.000" />

                        <!-- GiÃ¡ cÃ´ng -->
                        <Label Grid.Row="6" Grid.Column="0" Text="GiÃ¡ cÃ´ng:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="6" Grid.Column="1" Text="{Binding FormHangHoa.GiaCong}" Keyboard="Numeric" />

                        <!-- ÄÆ¡n giÃ¡ gá»‘c -->
                        <Label Grid.Row="7" Grid.Column="0" Text="ÄÆ¡n giÃ¡ gá»‘c:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="7" Grid.Column="1" Text="{Binding FormHangHoa.DonViGoc}" Keyboard="Numeric" />

                        <!-- Ghi chÃº -->
                        <Label Grid.Row="8" Grid.Column="0" Text="Ghi chÃº:" VerticalOptions="Center" FontSize="16" TextColor="#555" />
                        <Entry Grid.Row="8" Grid.Column="1" Text="{Binding FormHangHoa.GhiChu}" Placeholder="Nháº­p ghi chÃº" />
                    </Grid>
                </VerticalStackLayout>
            </ScrollView>

            <HorizontalStackLayout Grid.Row="2" HorizontalOptions="Center" Spacing="15">
                <Button Text="ðŸ’¾ LÆ°u" Command="{Binding SaveEditCommand}" 
                        BackgroundColor="#FFCF07" TextColor="White" WidthRequest="120" HeightRequest="45" CornerRadius="22" />
                <Button Text="âŒ Há»§y" Command="{Binding CancelFormCommand}" 
                        BackgroundColor="#9E9E9E" TextColor="White" WidthRequest="120" HeightRequest="45" CornerRadius="22" />
            </HorizontalStackLayout>
        </Grid>

        <!-- KHU Vá»°C DANH SÃCH HÃ€NG HÃ“A -->
        <ScrollView Grid.Row="1" IsVisible="{Binding IsAdding, Converter={StaticResource InverseBoolConverter}}">
            <ScrollView.Triggers>
                <DataTrigger TargetType="ScrollView" Binding="{Binding IsEditing}" Value="True">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </ScrollView.Triggers>

            <VerticalStackLayout Spacing="15">
                
                
                <CollectionView ItemsSource="{Binding DanhSachHangHoa}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedHangHoa, Mode=TwoWay}">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" Span="2" HorizontalItemSpacing="10" VerticalItemSpacing="10" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame CornerRadius="10" Padding="10" HasShadow="True" BackgroundColor="#E8E8E8" 
                                   BorderColor="#DDD" Margin="3">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HangHoaViewModel}}, Path=SelectHangHoaCommand}" 
                                                          CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>
                                <Frame.Style>
                                    <Style TargetType="Frame">
                                        <Setter Property="BackgroundColor" Value="#E8E8E8" />
                                        <Setter Property="BorderColor" Value="#DDD" />
                                        <Setter Property="HasShadow" Value="True" />
                                        <Style.Triggers>
                                            <DataTrigger TargetType="Frame"
                                                Binding="{Binding IsSelected}" 
                                                Value="True">
                                                <Setter Property="BackgroundColor" Value="#E8E8E8"/>
                                                <Setter Property="BorderColor" Value="#FF9800"/>
                                                <Setter Property="HasShadow" Value="True" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Frame.Style>
                                <StackLayout Spacing="2">
                                    <!-- Header - TÃªn hÃ ng vÃ  ID -->
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Grid.Column="0" Text="{Binding TenHangHoa}" FontAttributes="Bold" FontSize="16" LineBreakMode="TailTruncation" TextColor="#333333" />
                                        <!-- Biá»ƒu tÆ°á»£ng Ä‘Ã¡nh dáº¥u Ä‘ang sá»­ dá»¥ng -->
                                        <Label Grid.Column="1" 
                                               Text="âœ“" 
                                               TextColor="Green" 
                                               FontSize="16" 
                                               IsVisible="{Binding SuDung, Converter={StaticResource IntToBoolConverter}}" />
                                    </Grid>
                                    <Label Text="{Binding Nhom, StringFormat='NhÃ³m vÃ ng: {0}'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding LoaiVang, StringFormat='Loáº¡i vÃ ng: {0}'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding CanTong, StringFormat='CÃ¢n tá»•ng: {0:N3}'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding TrongLuongHot, StringFormat='TL há»™t: {0:N3} L'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding TruHot, StringFormat='Trá»« há»™t: {0:N3}'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding CongGoc, StringFormat='CÃ´ng gá»‘c: {0:N0} VNÄ'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding GiaCong, StringFormat='GiÃ¡ cÃ´ng: {0:N0} VNÄ'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding DonViGoc, StringFormat='ÄÆ¡n giÃ¡ gá»‘c: {0:N0} VNÄ'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding GhiChu, StringFormat='Ghi chÃº: {0}'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding DinhGia, StringFormat='Äá»‹nh giÃ¡: {0:N0} VNÄ'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding LaiSuat, StringFormat='LÃ£i suáº¥t: {0:N2}%'}" FontSize="13" TextColor="#444444" />
                                    <Label Text="{Binding TienNhanThem, StringFormat='Tiá»n cáº§m thÃªm: {0:N0} VNÄ'}" FontSize="13" TextColor="#444444" />
                                </StackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- KHU Vá»°C PHÃ‚N TRANG - Äáº¶T á»ž DÆ¯á»šI CÃ™NG -->
        <Frame Grid.Row="2" 
               BackgroundColor="White" 
               BorderColor="#FF9800" 
               CornerRadius="10" 
               Padding="10" 
               Margin="0,10,0,0"
               HasShadow="True"
               IsVisible="{Binding IsAdding, Converter={StaticResource InverseBoolConverter}}">
            <Frame.Triggers>
                <DataTrigger TargetType="Frame" Binding="{Binding IsEditing}" Value="True">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </Frame.Triggers>
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="15">
                <Button Text="â—€ TrÆ°á»›c" 
                        Command="{Binding GoToPreviousPageCommand}" 
                        IsEnabled="{Binding CanGoPrevious}"
                        BackgroundColor="#FF9800"
                        TextColor="White"
                        WidthRequest="100"
                        HeightRequest="40"
                        CornerRadius="20"/>

                <Label Text="{Binding CurrentPage, StringFormat='Trang {0}'}"
                       VerticalOptions="Center"
                       FontSize="16"/>

                <Label Text="{Binding TotalPages, StringFormat='/ {0}'}"
                       VerticalOptions="Center"
                       FontSize="16"/>

                <Button Text="Sau â–¶"
                        Command="{Binding GoToNextPageCommand}"
                        IsEnabled="{Binding CanGoNext}"
                        BackgroundColor="#FF9800"
                        TextColor="White"
                        WidthRequest="100"
                        HeightRequest="40"
                        CornerRadius="20"/>
            </HorizontalStackLayout>
        </Frame>

        <!-- ThÃ´ng tin chÃ­nh -->
        <StackLayout Grid.Row="1" Spacing="2">
            <!-- DÃ²ng 1: NgÃ y cáº§m, QuÃ¡ háº¡n -->
            <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                <Label Text="NgÃ y cáº§m:" TextColor="#666"/>
                <Label Text="{Binding NgayCam, StringFormat='{0:dd/MM/yyyy}'}" TextColor="#333"/>
                <Label Text="QuÃ¡ háº¡n:" TextColor="#666"/>
                <Label Text="{Binding NgayQuaHan, StringFormat='{0:dd/MM/yyyy}'}" TextColor="#E74C3C"/>
            </Grid>
            <!-- DÃ²ng 2: CÃ¢n tá»•ng, TL há»™t -->
            <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                <Label Text="CÃ¢n tá»•ng:" TextColor="#666"/>
                <Label Text="{Binding CanTongInLuong, StringFormat='{0:N3} L'}" TextColor="#333"/>
                <Label Text="TL há»™t:" TextColor="#666"/>
                <Label Text="{Binding TLHot, StringFormat='{0:N3} L'}" TextColor="#333"/>
            </Grid>
            <!-- DÃ²ng 3: TL thá»±c, Äá»‹nh giÃ¡ -->
            <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                <Label Text="TL thá»±c:" TextColor="#666"/>
                <Label Text="{Binding TLThucInLuong, StringFormat='{0:N3} L'}" TextColor="#333"/>
                <Label Text="Äá»‹nh giÃ¡:" TextColor="#666"/>
                <Label Text="{Binding DinhGia, StringFormat='{0:N0} VNÄ'}" TextColor="#FF9800"/>
            </Grid>
            <!-- DÃ²ng 4: Tiá»n cáº§m thÃªm, LÃ£i suáº¥t -->
            <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="10">
                <Label Text="Tiá»n cáº§m thÃªm:" TextColor="#666"/>
                <Label Text="{Binding TienNhanThem, StringFormat='{0:N0} VNÄ'}" TextColor="#43A047"/>
                <Label Text="LÃ£i suáº¥t:" TextColor="#666"/>
                <Label Text="{Binding LaiSuat, StringFormat='{0:N2}%'}" TextColor="#E53935"/>
            </Grid>
        </StackLayout>
    </Grid>
</ContentPage>